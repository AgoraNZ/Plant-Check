<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dairy Shed Hygiene Checklist</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css">
    <style>
        body {
            background-color: #002B5C;
            color: #FFFFFF;
            font-family: Arial, sans-serif;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            margin: 0;
        }
        .container {
            background-color: #002B5C;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            max-width: 800px;
            width: 100%;
        }
        h1, h2 {
            color: #FF851B;
            text-align: center;
        }
        label {
            margin-top: 10px;
        }
        button {
            background-color: #FF851B;
            color: #FFFFFF;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            display: block;
            margin: 20px auto;
            border-radius: 5px;
        }
        button:hover {
            background-color: #FF4136;
        }
        .checklist-item {
            margin-bottom: 30px;
        }
        .form-control, .form-select {
            margin-top: 5px;
        }
        .version {
            text-align: center;
            margin-top: 20px;
            color: #FFFFFF;
            font-size: 12px;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <!-- Add Firebase scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.x.x/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.x.x/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.x.x/firebase-storage.js"></script>
</head>
<body>
    <div class="container">
        <h1>Dairy Shed Hygiene Checklist</h1>
        
        <form id="hygiene-checklist-form">
            <div class="section mb-4">
                <h2>Farm Details</h2>
                <!-- Form Inputs -->
                <label for="dairy-company">Dairy Company:</label>
                <select id="dairy-company" name="dairy-company" class="form-select">
                    <option value="fonterra">Fonterra</option>
                    <option value="dairy-goat-coop">Dairy Goat Co-op</option>
                    <option value="green-valley">Green Valley Dairies</option>
                    <option value="maui-milk">Maui Milk</option>
                    <option value="oceania">Oceania</option>
                    <option value="ofi">OFI</option>
                    <option value="synlait">Synlait Milk LTD</option>
                    <option value="tatua">Tatua</option>
                </select>

                <label for="dairy-number">Dairy Number:</label>
                <input type="text" class="form-control" id="dairy-number" name="dairy-number">

                <!-- Added visit-date field -->
                <label for="visit-date">Visit Date:</label>
                <input type="date" class="form-control" id="visit-date" name="visit-date">
            </div>
            
            <div class="section mb-4">
                <h2>Checklist Items</h2>
                <div id="checklist-items">
                    <!-- Checklist items will be dynamically added here -->
                </div>
            </div>

            <!-- Special Checklist Items: Hot Water Temp and Milk Temp -->
            <div class="section mb-4">
                <h2>Temperature Measurements</h2>
                <div class="checklist-item">
                    <label for="hot-water-temp">Hot Water Temp (°C):</label>
                    <input type="number" class="form-control" id="hot-water-temp" name="hot-water-temp" step="0.1">
                    
                    <label for="hot-water-time">Time Taken:</label>
                    <input type="time" class="form-control" id="hot-water-time" name="hot-water-time">
                </div>
                
                <div class="checklist-item">
                    <label for="milk-temp">Milk Temp (°C):</label>
                    <input type="number" class="form-control" id="milk-temp" name="milk-temp" step="0.1">
                    
                    <label for="milk-time">Time Taken:</label>
                    <input type="time" class="form-control" id="milk-time" name="milk-time">
                </div>
            </div>

            <button type="button" onclick="generatePDF()">Generate PDF</button>
        </form>
        <div class="version">Version 4.1</div>
    </div>

    <script>
        // Firebase configuration (provided by you)
        const firebaseConfig = {
            apiKey: "AIzaSyDr9nA44Kjejzeyg9E7nGUzbMDECI8cTFI",
            authDomain: "dairy-farm-record-system.firebaseapp.com",
            projectId: "dairy-farm-record-system",
            storageBucket: "dairy-farm-record-system.appspot.com",
            messagingSenderId: "422124188212",
            appId: "1:422124188212:web:1bd31bee8d6e91e301d061"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const storage = firebase.storage();

        const { jsPDF } = window.jspdf;
        const checklistItems = [
            "Pulsator Airline", "Long Bend Elbows", "Automatic Cup and Remover", "Diaphragm", "Receiving Can",
            "Sanitary Trap", "Main Milk Line", "Milk Line Seals in Good Condition", "Stainless Droppers", "Long Milk Rubber",
            "Liner", "Cluster", "Cluster Seal", "Cluster Button", "Non Return Valve at Milk Pump", "Milk Pump",
            "Filter Housing", "Plate Cooler", "Interceptor", "Receiver Airline", "Flushing Pulsator", "Air Purge Valve",
            "Vacuum Level", "Main Airline", "Plant Drainage - Milk Pump", "Plant Drainage - Filter/s", "Plant Drainage - Plate Cooler",
            "Plant Drainage - Vat Entry", "Plant Wash Tap", "Wash Jetters", "Centre Gland", "Test Bucket", "Inlet Valve",
            "Non-Return Valve", "Spray Ball", "Agitator", "Silo Door", "Manhole Seal", "Vat Outlet", "Walls in Silo"
        ];

        document.addEventListener("DOMContentLoaded", () => {
            // Set today's date in the visit-date field
            const today = new Date().toISOString().split('T')[0];
            const visitDateField = document.getElementById('visit-date');
            if (visitDateField) {
                visitDateField.value = today;
            }

            const checklistContainer = document.getElementById('checklist-items');
            checklistContainer.innerHTML = '';

            // Adding checklist items to the DOM
            checklistItems.forEach(item => {
                const itemContainer = document.createElement('div');
                itemContainer.classList.add('checklist-item');

                const label = document.createElement('label');
                label.textContent = item;
                itemContainer.appendChild(label);

                const statusSelect = document.createElement('select');
                statusSelect.classList.add('form-select');
                statusSelect.innerHTML = `
                    <option value="ok">OK</option>
                    <option value="attention-required">Attention Required</option>
                    <option value="na">N/A</option>
                    <option value="not-checked">Not Checked</option>
                `;
                itemContainer.appendChild(statusSelect);

                const commentsInput = document.createElement('input');
                commentsInput.type = 'text';
                commentsInput.classList.add('form-control');
                commentsInput.placeholder = 'Comments';
                itemContainer.appendChild(commentsInput);

                const imageUpload = document.createElement('input');
                imageUpload.type = 'file';
                imageUpload.classList.add('form-control', 'image-upload');
                imageUpload.style.display = 'none';
                itemContainer.appendChild(imageUpload);

                statusSelect.addEventListener('change', () => {
                    if (statusSelect.value === 'attention-required') {
                        imageUpload.style.display = 'block';
                    } else {
                        imageUpload.style.display = 'none';
                    }

                    if (statusSelect.value === 'not-checked') {
                        commentsInput.value = "Milk in Vat";
                    } else {
                        if (commentsInput.value === "Milk in Vat") {
                            commentsInput.value = "";
                        }
                    }
                });

                checklistContainer.appendChild(itemContainer);
            });
        });

        async function generatePDF() {
            const form = document.getElementById('hygiene-checklist-form');
            let formData = new FormData(form);
            const dairyNumber = formData.get('dairy-number');

            let pdf = new jsPDF('p', 'pt', 'a4');
            pdf.setFontSize(22);
            pdf.setTextColor('#002B5C');
            pdf.text('Dairy Shed Hygiene Checklist', 40, 50);

            // Add farm details to PDF (as before)

            // Save PDF to Firebase Storage
            const pdfBlob = pdf.output('blob');
            const timestamp = new Date().toISOString().split('T')[0];
            const fileName = `${dairyNumber}-form-${timestamp}.pdf`;
            const storageRef = storage.ref(`customers/${dairyNumber}/${fileName}`);

            storageRef.put(pdfBlob).then((snapshot) => {
                console.log('PDF uploaded successfully:', snapshot.metadata.fullPath);
            }).catch((error) => {
                console.error('Error uploading PDF:', error);
            });

            pdf.save('Dairy_Shed_Hygiene_Checklist.pdf');
        }
    </script>
</body>
</html>
