async function generatePDF() {
    const form = document.getElementById('hygiene-checklist-form');
    let formData = new FormData(form);
    const dairyNumber = formData.get('dairy-number');

    let pdf = new jsPDF('p', 'pt', 'a4');
    pdf.setFontSize(22);
    pdf.setTextColor('#002B5C');
    
    // Add the logo to the top of the PDF
    const logo = "data:image/jpeg;base64,qWwsGwozTLcPwpbteBfFvTb9zPIHOFiRAOtIC2L7wLa-8IO4USfbPnztafMCilOQljBU9dE1XSOTFw2vXSDk9rZ2E2qbmJyyFjITwhbcTo3YOC4KdZbvBXEroS0mvKK27UZC1-mTzOQuCkrp7ukm37eJlBI-d8tfVJEzODL6mAUHTApsGIfZFFYXMFRCnH1A8dC-NmtoLBogoYsRUtQg0bEishMW8uWKlV3vD5pItPaEAEHUcwdqPP1nok9oshcB7bnJsLOLMmDI4qVaCQNjyll4TgKVN2iUOQrkKpczSJAmF54nblrKNwWWFsurPFmGniahKSdwzDqkSRunAMxEvV90ChdtZnMwCMO3Gms9VVA0_fJYgD77T2fAtBov0-oZFIK62NEsW0BRaJfRAQMHMrhqS0KYgmnT3vEPaimIqGs4iVROKAlFdHBDiOETBitMjqKljXNW5LiAooH9sXEWS0FHRUQDp4quk2BtHJkYz5T-9V3kCmsdRLbB6nsJXMyJgRNNaY6FBepmZAFURGVOjSIpIEWdVyAf1QAqlqwz3SjaGPyct9gtfIANqPwYnp9cp4M-eKVvea8gk99576D7zHucOcvyHsPoyX3Hk_-Odw5EhMH-6cHGvUmtHjaqbR_OGAv1m04U1C6WmScnai1bXjzeufFQP47lR8bYiMuRT37kQIwpfDryeO_J_33joBhlPh5aevfG0b4Dr1dWNLx2MJfDy3WarF8IZhMISICJHxvn9VKBunUjlCPwm4gDuwbPXoqNXInBwDfDYwE-J-ZZmQ8N5Sr7UYJU";
    pdf.addImage(logo, 'JPEG', 40, 30, 150, 75);

    pdf.text('Dairy Shed Hygiene Checklist', 40, 120);

    pdf.setFontSize(12);
    pdf.setTextColor('#000000');
    pdf.setFont('helvetica', 'bold');
    pdf.text('Farm Details:', 40, 140);

    pdf.setFont('helvetica', 'normal');
    pdf.text(`Dairy Company: ${formData.get('dairy-company')}`, 40, 160);
    pdf.text(`Dairy Number: ${formData.get('dairy-number')}`, 40, 175);
    pdf.text(`Address: ${formData.get('address')}`, 40, 190);
    pdf.text(`Customer Name: ${formData.get('customer-name')}`, 40, 205);
    pdf.text(`Region: ${formData.get('region')}`, 40, 220);
    pdf.text(`Farm Name: ${formData.get('farm-name')}`, 40, 235);
    pdf.text(`Island: ${formData.get('island')}`, 40, 250);
    pdf.text(`Visit Date: ${formData.get('visit-date')}`, 40, 265);
    pdf.text(`Visit Type: ${formData.get('visit-type')}`, 40, 280);
    pdf.text(`Inspection Start Time: ${formData.get('inspection-start-time')}`, 40, 295);
    pdf.text(`Inspection End Time: ${formData.get('inspection-end-time')}`, 40, 310);
    pdf.text(`Inspection Completed By: ${formData.get('inspection-completed-by')}`, 40, 325);
    pdf.text(`Call Type: ${formData.get('call-type')}`, 40, 340);

    const checklistItemsDiv = document.getElementById('checklist-items').children;

    const checklistTable = [];
    const images = [];

    for (let item of checklistItemsDiv) {
        const itemName = item.querySelector('label').textContent;
        const status = item.querySelector('select').value;
        const comments = item.querySelector('input[type="text"]').value;
        const imageFile = item.querySelector('input[type="file"]').files[0];

        const row = [itemName, status, comments];

        if (imageFile) {
            const reader = new FileReader();
            reader.onload = function (event) {
                images.push({ image: event.target.result, itemName: itemName });
            };
            reader.readAsDataURL(imageFile);
            await new Promise((resolve) => reader.onloadend = resolve);
        }

        checklistTable.push(row);
    }

    // Generate checklist items table
    pdf.autoTable({
        startY: 360,
        head: [['Item', 'Status', 'Comments']],
        body: checklistTable,
        styles: {
            fontSize: 10,
            cellPadding: 5,
        },
        headStyles: {
            fillColor: '#002B5C',
            textColor: '#FFFFFF'
        }
    });

    // Add temperature data
    let currentY = pdf.lastAutoTable.finalY + 20;

    pdf.setFont('helvetica', 'bold');
    pdf.text('Temperature Measurements:', 40, currentY);
    currentY += 20;

    pdf.setFont('helvetica', 'normal');
    pdf.text(`Hot Water Temp: ${formData.get('hot-water-temp')} °C`, 40, currentY);
    currentY += 15;
    pdf.text(`Time Taken: ${formData.get('hot-water-time')}`, 40, currentY);
    currentY += 20;

    pdf.text(`Milk Temp: ${formData.get('milk-temp')} °C`, 40, currentY);
    currentY += 15;
    pdf.text(`Time Taken: ${formData.get('milk-time')}`, 40, currentY);
    currentY += 20;

    // Add images below the table with proper alignment
    if (images.length > 0) {
        pdf.setFont('helvetica', 'bold');
        pdf.text('Photos:', 40, currentY);
        currentY += 20;

        images.forEach((imgDetail, index) => {
            pdf.setFont('helvetica', 'normal');
            pdf.text(`Item: ${imgDetail.itemName}`, 40, currentY);
            currentY += 10;

            const pageHeight = pdf.internal.pageSize.height;

            // Check if adding the image exceeds the page height
            if (currentY + 160 > pageHeight) {
                pdf.addPage();
                currentY = 50; // Reset Y position for new page
            }

            pdf.addImage(imgDetail.image, 'JPEG', 40, currentY, 150, 150);
            currentY += 160; // Spacing for the next image
        });
    }

    // Save PDF and upload to Firebase
    const pdfBlob = pdf.output('blob');
    const timestamp = new Date().toISOString().split('T')[0];
    const fileName = `${dairyNumber}-form-${timestamp}.pdf`;
    const storageRef = storage.ref(`customers/${dairyNumber}/${fileName}`);

    try {
        await storageRef.put(pdfBlob);
        console.log('PDF uploaded successfully');
    } catch (error) {
        console.error('Error uploading PDF:', error);
    }

    pdf.save('Dairy_Shed_Hygiene_Checklist.pdf');
}
