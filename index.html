async function generatePDF() {
    const form = document.getElementById('hygiene-checklist-form');
    let formData = new FormData(form);
    const dairyNumber = formData.get('dairy-number');

    let pdf = new jsPDF('p', 'pt', 'a4');
    pdf.setFontSize(22);
    pdf.setTextColor('#002B5C');
    pdf.text('Dairy Shed Hygiene Checklist', 40, 50);

    // Add the DEOSAN logo
    const logoUrl = "https://firebasestorage.googleapis.com/v0/b/dairy-farm-record-system.appspot.com/o/DEOSAN_ON_BLUE.jpg?alt=media&token=95fec682-0de4-4a60-93a8-736ad082d782";
    const logo = new Image();
    logo.src = logoUrl;
    await new Promise((resolve) => {
        logo.onload = () => {
            pdf.addImage(logo, 'JPEG', 40, 70, 100, 40);
            resolve();
        };
    });

    pdf.setFontSize(12);
    pdf.setTextColor('#000000');
    pdf.setFont('helvetica', 'bold');
    pdf.text('Farm Details:', 40, 130);

    pdf.setFont('helvetica', 'normal');
    pdf.text(`Dairy Company: ${formData.get('dairy-company')}`, 40, 150);
    pdf.text(`Dairy Number: ${formData.get('dairy-number')}`, 40, 165);
    pdf.text(`Address: ${formData.get('address')}`, 40, 180);
    pdf.text(`Customer Name: ${formData.get('customer-name')}`, 40, 195);
    pdf.text(`Region: ${formData.get('region')}`, 40, 210);
    pdf.text(`Farm Name: ${formData.get('farm-name')}`, 40, 225);
    pdf.text(`Island: ${formData.get('island')}`, 40, 240);
    pdf.text(`Visit Date: ${formData.get('visit-date')}`, 40, 255);
    pdf.text(`Visit Type: ${formData.get('visit-type')}`, 40, 270);
    pdf.text(`Inspection Start Time: ${formData.get('inspection-start-time')}`, 40, 285);
    pdf.text(`Inspection End Time: ${formData.get('inspection-end-time')}`, 40, 300);
    pdf.text(`Inspection Completed By: ${formData.get('inspection-completed-by')}`, 40, 315);
    pdf.text(`Call Type: ${formData.get('call-type')}`, 40, 330);

    const checklistItemsDiv = document.getElementById('checklist-items').children;

    const checklistTable = [];
    const images = [];

    for (let item of checklistItemsDiv) {
        const itemName = item.querySelector('label').textContent;
        const status = item.querySelector('select').value;
        const comments = item.querySelector('input[type="text"]').value;
        const imageFile = item.querySelector('input[type="file"]').files[0];

        const row = [itemName, status, comments];

        if (imageFile) {
            const reader = new FileReader();
            reader.onload = function (event) {
                images.push({ image: event.target.result, itemName: itemName });
            };
            reader.readAsDataURL(imageFile);
            await new Promise((resolve) => reader.onloadend = resolve);
        }

        checklistTable.push(row);
    }

    // Generate checklist items table
    pdf.autoTable({
        startY: 350,
        head: [['Item', 'Status', 'Comments']],
        body: checklistTable,
        styles: {
            fontSize: 10,
            cellPadding: 5,
        },
        headStyles: {
            fillColor: '#002B5C',
            textColor: '#FFFFFF'
        }
    });

    // Add images below the table with proper alignment
    let currentY = pdf.lastAutoTable.finalY + 20;

    if (images.length > 0) {
        pdf.setFont('helvetica', 'bold');
        pdf.text('Photos:', 40, currentY);
        currentY += 20;

        images.forEach((imgDetail, index) => {
            pdf.setFont('helvetica', 'normal');
            pdf.text(`Item: ${imgDetail.itemName}`, 40, currentY);
            currentY += 10;

            const pageHeight = pdf.internal.pageSize.height;

            // Check if adding the image exceeds the page height
            if (currentY + 160 > pageHeight) {
                pdf.addPage();
                currentY = 50; // Reset Y position for new page
            }

            pdf.addImage(imgDetail.image, 'JPEG', 40, currentY, 150, 150);
            currentY += 160; // Spacing for the next image
        });
    }

    // Save PDF and upload to Firebase
    const pdfBlob = pdf.output('blob');
    const timestamp = new Date().toISOString().split('T')[0];
    const fileName = `${dairyNumber}-form-${timestamp}.pdf`;
    const storageRef = storage.ref(`customers/${dairyNumber}/${fileName}`);

    try {
        await storageRef.put(pdfBlob);
        console.log('PDF uploaded successfully');
    } catch (error) {
        console.error('Error uploading PDF:', error);
    }

    pdf.save('Dairy_Shed_Hygiene_Checklist.pdf');
}
